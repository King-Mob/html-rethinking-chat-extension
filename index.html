<html>

<head>
    <title>Rethinking Chat element</title>
</head>

<body>
    <div id="container">Loading...</div>
    <p id="userId"></p>

    <script src="https://unpkg.com/matrix-widget-api@1.3.1/dist/api.min.js"></script>
    <script type="text/javascript">
        function parseFragment() {
            return new URLSearchParams(window.location.search);
        }

        function assertParam(fragment, name) {
            const val = fragment.get(name);
            if (!val) throw new Error(`${name} is not present in URL - cannot load widget`);
            return val;
        }

        function handleError(e) {
            console.error(e);
            document.getElementById("container").innerText = "There was an error with the widget. See JS console for details.";
        }

        try {
            const qs = parseFragment();
            const widgetId = assertParam(qs, "widgetId");
            const userId = assertParam(qs, "userId");
            // Allow all origins
            const targetOrigin = "*";
            let isSticky = false;

            // Set up the widget API as soon as possible to avoid problems with the client

            // const widgetApi = new mxwidgets().WidgetApi(widgetId, targetOrigin);
            const widgetApi = new (mxwidgets().WidgetApi)

            console.log(widgetApi)
            console.log(mxwidgets().MatrixCapabilities)

            widgetApi.requestCapability(mxwidgets().MatrixCapabilities.AlwaysOnScreen);

            widgetApi.on("ready", function () {
                // Fill in the basic widget details now that we're allowed to operate.
                document.getElementById("container").innerHTML =
                    "Hello <span id='userId'></span>!<br /><br />" +
                    "Currently stuck on screen: <span id='stickyState'></span><br /><br />" +
                    "<button onclick='toggleSticky()'>Toggle sticky state</button>";

                // Fill in the user ID using innerText to avoid XSS
                document.getElementById("userId").innerText = userId;

                // Update the UI and ensure that we end up not sticky to start
                sendStickyState();
            });

            // Start the widget as soon as possible too, otherwise the client might time us out.
            widgetApi.start();

            function toggleSticky() {
                // called by the button when clicked - toggle the sticky state
                isSticky = !isSticky;
                sendStickyState();
            }

            function updateStickyState() {
                document.getElementById("stickyState").innerText = isSticky.toString();
            }

            function sendStickyState() {
                updateStickyState(); // update first to make the UI go faster than the request
                widgetApi
                    .setAlwaysOnScreen(isSticky)
                    .then(function (r) {
                        console.log("[Widget] Client responded with: ", r);
                    })
                    .catch(function (e) {
                        handleError(e)
                    });
            }
        } catch (e) {
            handleError(e)
        }
    </script>
</body>

</html>